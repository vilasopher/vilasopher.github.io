<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://cindyjs.org/dist/latest/Cindy.js"></script>
    <script type="text/javascript" src="https://cindyjs.org/dist/latest/CindyGL.js"></script>
    <title>XY Model</title>
  </head>

	<body style="margin:0;padding:0;overflow:hidden;">
    <div id="CSCanvas"></div>

    <script id="csinit" type="text/x-cindyscript">
      use("CindyGL");

      corners = screenbounds();
      W = dist(corners_1, corners_2); 
      H = dist(corners_1, corners_4);
      temp = 1/2;
      invrate = 0.05;
      
      L = [0, 0]; //bottom left corner
      R = [W, 0]; //bottom right corner

      pressed = false;

      createimage("state", W, H);

      randomOnCircle() := (
        t = random();
        (0.5*(cos(2*pi*t)+1), 0.5*(sin(2*pi*t)+1), 0);
      );

      colorplot(L, R, "state", randomOnCircle());

      get(x, y) := imagergb(L, R, "state", (mod(x,W), mod(y,H)));

      shiftedDotProduct(a,b) := (2*a_1-1) * (2*b_1-1) + (2*a_2-1) * (2*b_2-1);

      energy(x, y, spin) := - (shiftedDotProduct(spin, get(x,y+1)) + shiftedDotProduct(spin, get(x,y-1)) + shiftedDotProduct(spin, get(x+1,y)) + shiftedDotProduct(spin, get(x-1,y)));

      newstate(x, y) := (
        current = get(x, y);
        proposal = randomOnCircle();

        currentEnergy = energy(x, y, current);
        proposalEnergy = energy(x, y, proposal);

        if (random() < exp((-1/temp)*(proposalEnergy - currentEnergy)), proposal, current);
      );

      textbox = polygon([(50,50), (50,80), (260,80), (260,50)]);

      PUhue(t) := (
        if(t<1/256, (0.96726, 0.21404, 0.10285), if(t<2/256, (0.96657, 0.21983, 0.0919), if(t<3/256, (0.96633, 0.22834, 0.081637), if(t<4/256, (0.96652, 0.23917, 0.071996), if(t<5/256, (0.9671, 0.25198, 0.063086), if(t<6/256, (0.96804, 0.26633, 0.054632), if(t<7/256, (0.96927, 0.28187, 0.046867), if(t<8/256, (0.97077, 0.29827, 0.039573), if(t<9/256, (0.97247, 0.31531, 0.032902), if(t<10/256, (0.97433, 0.33274, 0.027416), if(t<11/256, (0.9763, 0.35036, 0.022767), if(t<12/256, (0.97835, 0.36807, 0.018802), if(t<13/256, (0.98044, 0.38577, 0.015391), if(t<14/256, (0.98254, 0.40339, 0.012442), if(t<15/256, (0.98463, 0.42085, 0.009625), if(t<16/256, (0.98667, 0.43815, 0.007288), if(t<17/256, (0.98867, 0.45524, 0.005171), if(t<18/256, (0.99061, 0.47213, 0.003222), if(t<19/256, (0.99248, 0.4888, 0.001403), if(t<20/256, (0.99427, 0.50528, 0), if(t<21/256, (0.99598, 0.52156, 0), if(t<22/256, (0.99761, 0.53767, 0), if(t<23/256, (0.99914, 0.55359, 0), if(t<24/256, (1, 0.56934, 0), if(t<25/256, (1, 0.58494, 0), if(t<26/256, (1, 0.60037, 0), if(t<27/256, (1, 0.61565, 0), if(t<28/256, (1, 0.63077, 0), if(t<29/256, (1, 0.64572, 0), if(t<30/256, (1, 0.66048, 0), if(t<31/256, (1, 0.67504, 0), if(t<32/256, (1, 0.68935, 0), if(t<33/256, (1, 0.70336, 0), if(t<34/256, (1, 0.71701, 0), if(t<35/256, (1, 0.73023, 0), if(t<36/256, (1, 0.74293, 0), if(t<37/256, (0.99701, 0.75501, 0), if(t<38/256, (0.99313, 0.76637, 0), if(t<39/256, (0.98833, 0.77691, 0), if(t<40/256, (0.98256, 0.78651, 0), if(t<41/256, (0.97574, 0.79507, 0), if(t<42/256, (0.96785, 0.80251, 0), if(t<43/256, (0.95886, 0.80875, 0), if(t<44/256, (0.94877, 0.81373, 0), if(t<45/256, (0.93761, 0.81743, 0), if(t<46/256, (0.92543, 0.81985, 0), if(t<47/256, (0.91229, 0.821, 0), if(t<48/256, (0.89826, 0.82095, 0), if(t<49/256, (0.88344, 0.81974, 0), if(t<50/256, (0.86793, 0.8175, 0), if(t<51/256, (0.8518, 0.8143, 0), if(t<52/256, (0.83517, 0.81025, 0), if(t<53/256, (0.81812, 0.80549, 0), if(t<54/256, (0.80073, 0.8001, 0), if(t<55/256, (0.78306, 0.7942, 0), if(t<56/256, (0.76518, 0.78786, 0), if(t<57/256, (0.74713, 0.7812, 0), if(t<58/256, (0.72895, 0.77426, 0), if(t<59/256, (0.71067, 0.76712, 0), if(t<60/256, (0.69231, 0.75982, 0), if(t<61/256, (0.67387, 0.7524, 0), if(t<62/256, (0.65537, 0.74489, 0), if(t<63/256, (0.63682, 0.73731, 0), if(t<64/256, (0.61821, 0.72968, 0), if(t<65/256, (0.59952, 0.722, 0), if(t<66/256, (0.58077, 0.7143, 8.8e-05), if(t<67/256, (0.56197, 0.7066, 0.001364), if(t<68/256, (0.54309, 0.69889, 0.002744), if(t<69/256, (0.52413, 0.69121, 0.004275), if(t<70/256, (0.50511, 0.68355, 0.006019), if(t<71/256, (0.48603, 0.67593, 0.008055), if(t<72/256, (0.46689, 0.66839, 0.010459), if(t<73/256, (0.4477, 0.66094, 0.013625), if(t<74/256, (0.42851, 0.65363, 0.017232), if(t<75/256, (0.40933, 0.6465, 0.021673), if(t<76/256, (0.39021, 0.63962, 0.027147), if(t<77/256, (0.37122, 0.63303, 0.033854), if(t<78/256, (0.35244, 0.62683, 0.042288), if(t<79/256, (0.33395, 0.62109, 0.05131), if(t<80/256, (0.31583, 0.61589, 0.06103), if(t<81/256, (0.29817, 0.61133, 0.071492), if(t<82/256, (0.28114, 0.60749, 0.082491), if(t<83/256, (0.26486, 0.60444, 0.094141), if(t<84/256, (0.24945, 0.60226, 0.10646), if(t<85/256, (0.23509, 0.60102, 0.11935), if(t<86/256, (0.22182, 0.60075, 0.13293), if(t<87/256, (0.20988, 0.60148, 0.14712), if(t<88/256, (0.19934, 0.60321, 0.16196), if(t<89/256, (0.19034, 0.60592, 0.17737), if(t<90/256, (0.18291, 0.60959, 0.19335), if(t<91/256, (0.17711, 0.61414, 0.20988), if(t<92/256, (0.17287, 0.61953, 0.22692), if(t<93/256, (0.17015, 0.62567, 0.24439), if(t<94/256, (0.16879, 0.63248, 0.2623), if(t<95/256, (0.16861, 0.63987, 0.28053), if(t<96/256, (0.16945, 0.64776, 0.2991), if(t<97/256, (0.17103, 0.65608, 0.31789), if(t<98/256, (0.17321, 0.66474, 0.3369), if(t<99/256, (0.17578, 0.67369, 0.35607), if(t<100/256, (0.17862, 0.68287, 0.37537), if(t<101/256, (0.18147, 0.69224, 0.39479), if(t<102/256, (0.18433, 0.70173, 0.4143), if(t<103/256, (0.18705, 0.71136, 0.43387), if(t<104/256, (0.18954, 0.72106, 0.45351), if(t<105/256, (0.19176, 0.73084, 0.4732), if(t<106/256, (0.19369, 0.74067, 0.49294), if(t<107/256, (0.19522, 0.75056, 0.51274), if(t<108/256, (0.19644, 0.76048, 0.53259), if(t<109/256, (0.1972, 0.77042, 0.55248), if(t<110/256, (0.19751, 0.78036, 0.5724), if(t<111/256, (0.19739, 0.7903, 0.59236), if(t<112/256, (0.19681, 0.80022, 0.61235), if(t<113/256, (0.19573, 0.81009, 0.63237), if(t<114/256, (0.19423, 0.81989, 0.65241), if(t<115/256, (0.1922, 0.82959, 0.67244), if(t<116/256, (0.18974, 0.83913, 0.69245), if(t<117/256, (0.18683, 0.84847, 0.71238), if(t<118/256, (0.1835, 0.85752, 0.73222), if(t<119/256, (0.1798, 0.86622, 0.75189), if(t<120/256, (0.17577, 0.87446, 0.77133), if(t<121/256, (0.17154, 0.88215, 0.79046), if(t<122/256, (0.1672, 0.88917, 0.8092), if(t<123/256, (0.16285, 0.89541, 0.82742), if(t<124/256, (0.15866, 0.90075, 0.84505), if(t<125/256, (0.15479, 0.90508, 0.86196), if(t<126/256, (0.15145, 0.9083, 0.87804), if(t<127/256, (0.1488, 0.91033, 0.89319), if(t<128/256, (0.147, 0.9111, 0.90734), if(t<129/256, (0.14614, 0.91058, 0.9204), if(t<130/256, (0.14627, 0.90875, 0.93232), if(t<131/256, (0.1474, 0.90562, 0.94309), if(t<132/256, (0.14944, 0.90123, 0.9527), if(t<133/256, (0.15222, 0.89566, 0.96117), if(t<134/256, (0.15567, 0.88898, 0.96855), if(t<135/256, (0.15952, 0.8813, 0.97492), if(t<136/256, (0.16369, 0.87272, 0.98035), if(t<137/256, (0.16789, 0.86336, 0.98494), if(t<138/256, (0.17206, 0.85333, 0.9888), if(t<139/256, (0.17603, 0.84276, 0.99201), if(t<140/256, (0.17975, 0.83174, 0.99468), if(t<141/256, (0.18308, 0.82034, 0.99691), if(t<142/256, (0.18603, 0.80867, 0.99878), if(t<143/256, (0.18848, 0.79679, 1), if(t<144/256, (0.19041, 0.78475, 1), if(t<145/256, (0.19184, 0.7726, 1), if(t<146/256, (0.19274, 0.76037, 1), if(t<147/256, (0.1931, 0.74809, 1), if(t<148/256, (0.1929, 0.73578, 1), if(t<149/256, (0.19214, 0.72346, 1), if(t<150/256, (0.19086, 0.71113, 1), if(t<151/256, (0.18909, 0.6988, 1), if(t<152/256, (0.18679, 0.68652, 1), if(t<153/256, (0.18401, 0.67427, 1), if(t<154/256, (0.18079, 0.66207, 1), if(t<155/256, (0.17723, 0.64994, 1), if(t<156/256, (0.17333, 0.63789, 1), if(t<157/256, (0.16932, 0.62596, 1), if(t<158/256, (0.16523, 0.61417, 1), if(t<159/256, (0.16146, 0.60259, 1), if(t<160/256, (0.15814, 0.59124, 1), if(t<161/256, (0.1557, 0.58022, 1), if(t<162/256, (0.1545, 0.56956, 1), if(t<163/256, (0.15501, 0.55939, 1), if(t<164/256, (0.15757, 0.54976, 1), if(t<165/256, (0.16255, 0.54079, 1), if(t<166/256, (0.17005, 0.53257, 1), if(t<167/256, (0.18013, 0.52519, 1), if(t<168/256, (0.19269, 0.51875, 1), if(t<169/256, (0.20747, 0.51331, 1), if(t<170/256, (0.22414, 0.50895, 1), if(t<171/256, (0.24245, 0.50571, 1), if(t<172/256, (0.26202, 0.50364, 1), if(t<173/256, (0.28258, 0.50272, 1), if(t<174/256, (0.30381, 0.50294, 1), if(t<175/256, (0.32553, 0.50429, 1), if(t<176/256, (0.34755, 0.50666, 1), if(t<177/256, (0.36963, 0.51003, 1), if(t<178/256, (0.39169, 0.51429, 1), if(t<179/256, (0.41358, 0.51935, 1), if(t<180/256, (0.43525, 0.52511, 1), if(t<181/256, (0.45659, 0.53148, 1), if(t<182/256, (0.4776, 0.53838, 1), if(t<183/256, (0.49823, 0.5457, 1), if(t<184/256, (0.51845, 0.55337, 1), if(t<185/256, (0.53827, 0.56134, 1), if(t<186/256, (0.5577, 0.56954, 1), if(t<187/256, (0.57675, 0.57793, 1), if(t<188/256, (0.59542, 0.58647, 1), if(t<189/256, (0.61374, 0.59512, 1), if(t<190/256, (0.63175, 0.60388, 1), if(t<191/256, (0.64945, 0.61271, 1), if(t<192/256, (0.66687, 0.6216, 1), if(t<193/256, (0.68404, 0.63055, 1), if(t<194/256, (0.70098, 0.6395, 1), if(t<195/256, (0.7177, 0.64845, 1), if(t<196/256, (0.73421, 0.65739, 1), if(t<197/256, (0.75055, 0.66627, 1), if(t<198/256, (0.76671, 0.67509, 1), if(t<199/256, (0.78273, 0.68379, 1), if(t<200/256, (0.7986, 0.69233, 1), if(t<201/256, (0.81433, 0.70062, 1), if(t<202/256, (0.8299, 0.70861, 1), if(t<203/256, (0.8453, 0.7162, 1), if(t<204/256, (0.86052, 0.72328, 1), if(t<205/256, (0.8755, 0.72977, 1), if(t<206/256, (0.89021, 0.73553, 0.99966), if(t<207/256, (0.90458, 0.74046, 0.99387), if(t<208/256, (0.91855, 0.74442, 0.987), if(t<209/256, (0.93205, 0.74732, 0.97894), if(t<210/256, (0.94498, 0.74904, 0.96964), if(t<211/256, (0.95728, 0.74952, 0.95905), if(t<212/256, (0.96886, 0.74869, 0.94717), if(t<213/256, (0.97965, 0.74653, 0.93399), if(t<214/256, (0.9896, 0.74302, 0.91958), if(t<215/256, (0.99865, 0.73818, 0.90399), if(t<216/256, (1, 0.73207, 0.88731), if(t<217/256, (1, 0.72474, 0.86966), if(t<218/256, (1, 0.7163, 0.85114), if(t<219/256, (1, 0.70684, 0.83189), if(t<220/256, (1, 0.69646, 0.81201), if(t<221/256, (1, 0.68529, 0.79164), if(t<222/256, (1, 0.67343, 0.77088), if(t<223/256, (1, 0.66099, 0.74982), if(t<224/256, (1, 0.64806, 0.72855), if(t<225/256, (1, 0.63473, 0.70715), if(t<226/256, (1, 0.62107, 0.68567), if(t<227/256, (1, 0.60713, 0.66415), if(t<228/256, (1, 0.59297, 0.64264), if(t<229/256, (1, 0.5786, 0.62116), if(t<230/256, (1, 0.56409, 0.59973), if(t<231/256, (1, 0.54941, 0.57836), if(t<232/256, (1, 0.53459, 0.55708), if(t<233/256, (1, 0.51964, 0.53586), if(t<234/256, (1, 0.50455, 0.51475), if(t<235/256, (1, 0.48929, 0.49372), if(t<236/256, (1, 0.47391, 0.4728), if(t<237/256, (1, 0.45838, 0.452), if(t<238/256, (1, 0.4427, 0.4313), if(t<239/256, (1, 0.42686, 0.41072), if(t<240/256, (1, 0.41086, 0.39028), if(t<241/256, (1, 0.39472, 0.37), if(t<242/256, (1, 0.37845, 0.34992), if(t<243/256, (1, 0.36209, 0.33004), if(t<244/256, (1, 0.34568, 0.31042), if(t<245/256, (1, 0.32933, 0.29109), if(t<246/256, (0.99872, 0.31308, 0.2721), if(t<247/256, (0.99487, 0.29714, 0.25356), if(t<248/256, (0.99105, 0.28163, 0.23549), if(t<249/256, (0.98733, 0.26683, 0.21793), if(t<250/256, (0.98375, 0.25301, 0.20097), if(t<251/256, (0.98037, 0.24049, 0.18472), if(t<252/256, (0.97725, 0.22969, 0.16917), if(t<253/256, (0.97445, 0.22104, 0.15432), if(t<254/256, (0.97202, 0.21483, 0.14028), if(t<255/256, (0.96999, 0.21152, 0.127), (0.9684, 0.21123, 0.11451))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))))));
      );

      colorfunction(spin) := (
        x = 2*spin_1-1;
        y = 2*spin_2-1;
        t = (arctan2(x,y)+pi)/(2*pi);
        // TODO: perceptually uniformize the color space!
        // colors_(t * 256 + 1); // WHY DOESN'T THIS WORK??????
        // PUhue(t); // Expression too complex??
        hue(t);
      );
    </script>

    <script id="csdraw" type="text/x-cindyscript">
      repeat(20,
        colorplot(L, R, "state",
          if (random() < invrate, newstate(#.x, #.y), get(#.x, #.y))
        );
      );
      colorplot(colorfunction(imagergb("state", #)));

      if (pressed, (
          temp = max([0.000001,(mouse().y / H) * 2]);
          fill(textbox, color->(1,1,1));
          drawtext((60, 60), "temperature = " + temp);
        );
      );
    </script>

    <script id="csmousedown" type="text/x-cindyscript">
      pressed = true;
    </script>

    <script id="csmouseup" type="text/x-cindyscript">
      pressed = false;
    </script>

    <script type="text/javascript">
    CindyJS({
      scripts: "cs*",
      autoplay: true,
      ports: [{
        id: "CSCanvas",
        width: window.innerWidth,
        height: window.innerHeight,
        transform: [{
          visibleRect: [0, 0, window.innerWidth, window.innerHeight]
        }]
      }]
    });
    </script>
  </body>
</html>